---
title: "Combustion Model"
author: "Anna Talucci, edited by: Kayla Mathes"
date: '2023-08-03'
output: html_document
---

### VERY IMPORTANT!!! Before running this code don't forget to rename the final csv files to the correct fire name!!!! 


# Overview

Trouble shooting
https://stackoverflow.com/questions/30097730/error-when-using-predict-on-a-randomforest-object-trained-with-carets-train

# Library
```{r}
library(tidyverse)
library(ranger)
library(e1071)
library(arrow)
```
# Models
```{r}
above_model <- readRDS("../Retraining/Model_Above/Above_full_model_ranger.rds")
below_model <- readRDS("../Retraining/Model_Below/Below_full_model_ranger.rds")
depth_model <- readRDS("../Retraining/out_path_burndepth_2/full_model_ranger.rds")
```




```{r}
alldata = read.csv("../Counterfactual/Output/2006_ChloyaLakes/ChloyaLakes_AbovegroundCombustionRetrained.csv")

alldata <- alldata%>%
  dplyr::select(!prediction)

```
``

# Read in predictive data from stefano

```{r}
#abovefed <- read_parquet("../From_Anna/TrainingDataFrame/abovefed_for_predict.parquet")
#head(abovefed)
```

# Training Data

Original model training data from Stefano Potter. 

```{r}
above_train =  read.csv("../Retraining/new_aboveground_data_training_fortraining.csv", header=TRUE, sep = ",", strip.white = TRUE)
```

```{r}
below_train =  read.csv("../Retraining/new_belowground_data_training_fortraining.csv", header=TRUE, sep = ",", strip.white = TRUE)
```

```{r}
depth_train =  read.csv("../Retraining/new_burn_depth_fortraining.csv", header=TRUE, sep = ",", strip.white = TRUE)
```


```{r}
above_importance =  read.csv("../Retraining/Model_Above/rfe_importance.csv", header=TRUE, sep = ",", strip.white = TRUE)
```

```{r}
below_importance =  read.csv("../Retraining/Model_Below/rfe_importance.csv", header=TRUE, sep = ",", strip.white = TRUE)
```

```{r}
depth_importance =  read.csv("../Retraining/out_path_burndepth_2/rfe_importance.csv", header=TRUE, sep = ",", strip.white = TRUE)
```

# Check with AboveFed Training data

```{r}
##setdiff(names(abovefed), names(alldata))
```

```{r}
setdiff(names(depth_train), names(alldata))
```

```{r}
setdiff(names(above_train), names(alldata))
```

```{r}
setdiff(names(depth_train), names(below_train))
```
```{r}
setdiff(below_importance$Variables, names(alldata))
```

```{r}
setdiff(above_importance$Variables, names(alldata))
```


```{r}
setdiff(depth_importance$Variables, names(alldata))
```

```{r}
below_importance
```

# Select only importance variables and add column for combustion for training

Based on Stefano Potter's original model.

```{r}
above_train2 <- above_train %>% dplyr::select(above_importance$Variables)
below_train2 <- below_train %>% dplyr::select(below_importance$Variables)
depth_train2 <- depth_train %>% dplyr::select(depth_importance$Variables)
above_train2$above.carbon.combusted = above_train$above.carbon.combusted
below_train2$below.ground.carbon.combusted = below_train$below.ground.carbon.combusted
depth_train2$burn_depth = depth_train$burn_depth


```


# Training models 

Training each model with optimized parameters from Stefano Potter's ABOVEFed Model

```{r}
model_ranger_above <- ranger(above.carbon.combusted ~., data = above_train2, mtry = above_model$bestTune$mtry, splitrule = above_model$bestTune$splitrule, min.node.size = above_model$bestTune$min.node.size)
```

```{r}
model_ranger_below <- ranger(below.ground.carbon.combusted ~., data = below_train2, mtry = below_model$bestTune$mtry, splitrule = below_model$bestTune$splitrule, min.node.size = below_model$bestTune$min.node.size)
```

```{r}
model_ranger_depth <- ranger(burn_depth ~., data = depth_train2, mtry = depth_model$bestTune$mtry, splitrule = depth_model$bestTune$splitrule, min.node.size = depth_model$bestTune$min.node.size)

```



```{r}
rownames(below_model$importance)
below_model$bestTune$splitrule
below_model$bestTune$mtry
below_model$bestTune$min.node.size


rownames(depth_model$importance)
depth_model$bestTune$splitrule
depth_model$bestTune$mtry
depth_model$bestTune$min.node.size
```

# Predict combustion with all independent variables
These predictive models use all independent variables.

## Drop NA

Must remove NAs or it will not predict. 

```{r}
( alldata = alldata %>% drop_na() )
```
## select variables of interest

Following importance variables from Stefano's original model. 

```{r}
( alldataAbove = alldata %>% dplyr::select(above_importance$Variables) )
( alldataBelow = alldata %>% dplyr::select(below_importance$Variables) )

( alldatadepth = alldata %>% dplyr::select(depth_importance$Variables) )
```

## Aboveground preditions 

```{r}
pred_above = predict(model_ranger_above, alldataAbove)
```

```{r}
AbovepredResults <- data.frame(predict(model_ranger_above, alldataAbove))
AbovepredResults
```

```{r}
above_pred <- cbind(alldata, AbovepredResults)
above_pred
```

```{r eval=FALSE, include=FALSE}
write_csv(above_pred, "../Counterfactual/Output/2020_SwiftFork/SwiftFork_AbovegroundCombustionRetrained.csv")
```


## Below Combustion
 
```{r}
pred_below = predict(model_ranger_below, alldataBelow)

pred_depth = predict(model_ranger_depth, alldatadepth)

```

```{r}
BelowpredResults <- data.frame(predict(model_ranger_below, alldataBelow))
BelowpredResults


DepthpredResults <- data.frame(predict(model_ranger_depth, alldatadepth))
DepthpredResults

```

```{r}
below_pred <- cbind(alldata, BelowpredResults)
below_pred


depth_pred <- cbind(alldata, DepthpredResults)
depth_pred
```

```{r eval=FALSE, include=FALSE}
write_csv(depth_pred, "../Counterfactual/Output/2009_BigCreek/BigCreek_BurnDepthRetrained.csv")
```




## Burn Depth Predictions
 
```{r}

pred_depth = predict(model_ranger_depth, alldatadepth)

```

```{r}

DepthpredResults <- data.frame(predict(model_ranger_depth, alldatadepth))
DepthpredResults


```

```{r}

depth_pred <- cbind(alldata, DepthpredResults)
depth_pred
```

```{r eval=FALSE, include=FALSE}
write_csv(depth_pred, "../Counterfactual/Output/2006_ChloyaLakes/ChloyaLakes_BurnDepthRetrained.csv")
```
