---
title: "Combine Data for Combustion Model"
author: "Anna Talucci"
date: "2023-08-03"
output: html_document
---


# Overview

 
 Create on data frame with all sampled points and variables. The dataframe will be subset in the model script.

# Librarys
```{r}
library(tidyverse)
library(terra)
library(sf)
```

# Data
```{r}




ChloyaLakes <-st_read("../Counterfactual/Output/2006_ChloyaLakes/ChloyaLake_Burnpoints.shp")






```
## FWI

```{r}

FWI1 =  list.files(path="../Counterfactual/Output/Step04/FirstSet",pattern='*.csv', full.names = TRUE)%>%
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
    dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
   dplyr::select(!RID)


FWI2 =  list.files(path="../Counterfactual/Output/Step04/SecondSet",pattern='*.csv', full.names = TRUE)%>%
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
    dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
   dplyr::select(!RID)


FWI = merge(FWI1, FWI2, by = c( "ID", "lat", "lon"))



```

```{r}
min(FWI$fire_weather_index)
max(FWI$fire_weather_index)
```


### Terrain

```{r}
terrain =  list.files(path="../Counterfactual/Output/Step07/",pattern='*.csv', full.names = TRUE) %>%
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
    dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")

terrain <- terrain%>%
  mutate(duplicate = duplicated(.$RID))

terrain <- terrain%>%
  filter(duplicate != TRUE)%>%
  dplyr::select(!duplicate)%>%
   dplyr::select(!RID)

  

```

```{r}
terrain 
```

```{r}
 treecover =  list.files(path="../Counterfactual/Output/Step06/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv)  %>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows() %>%
    dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")


```

### veg
```{r}
sveg =  list.files(path="../Counterfactual/Output/Step05/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
    dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
    dplyr::select(!RID)


```

```{r}
sveg 
```

### Soil
```{r}

###In this case, I removed the static soil values that were equal to zero: These pixels are likely over water

ssoil =  list.files(path="../Counterfactual/Output/Step08/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  filter(BD_30 != 0)%>%
  dplyr::select(!RID)


```

```{r}
ssoil
```

### Soil
```{r}
spfi =  list.files(path="../Counterfactual/Output/Step09/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv)%>%
  map_dfr(., ~ .x %>%
        mutate(across(ID, as.character))) %>%
  bind_rows()%>%
  dplyr::select(ID:lon)


```

```{r}
spfi
```

### Join
```{r}
(static = full_join(FWI, spfi, by = c("lat", "lon", "ID"))%>%
   full_join(., treecover, by = c( "ID", "lat", "lon"))%>%
    full_join(., ssoil, by = c( "ID","lat", "lon"))%>%
     full_join(., sveg, by = c( "ID","lat", "lon"))%>%
    full_join(., terrain, by = c(  "ID","lat", "lon")))


static <- static%>%
  mutate(duplicate2 = duplicated(.$RID))

static <-  static%>%
  filter(duplicate2 != TRUE)%>%
  dplyr::select(!duplicate2)
 

```


## Climate NA

```{r}

climateNA1 = list.files(path="../Counterfactual/Output/Step10/First/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)


climateNA2 = list.files(path="../Counterfactual/Output/Step10/Second/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)



climateNA3 = list.files(path="../Counterfactual/Output/Step10/Third/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)



climateNA4 = list.files(path="../Counterfactual/Output/Step10/Fourth/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)



climateNA5 = list.files(path="../Counterfactual/Output/Step10/Fifth/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)




climateNA6 = list.files(path="../Counterfactual/Output/Step10/Sixth/",pattern='*.csv', full.names = TRUE) %>% 
  purrr::map(., read_csv) %>% 
  bind_rows()%>%
  dplyr::select(!"system:index")%>%
  dplyr::select(!ID1)%>%
  dplyr::select(!".geo")%>%
  dplyr::select(!RID)



climateNAtotal = merge(climateNA1, climateNA2, by = c( "lat", "lon", "ID"))
climateNAtotal = merge(climateNAtotal, climateNA3, by = c("lat", "lon", "ID"))
climateNAtotal = merge(climateNAtotal, climateNA4, by = c("lat", "lon", "ID"))
climateNAtotal = merge(climateNAtotal, climateNA5, by = c("lat", "lon", "ID"))
 climateNAtotal = merge(climateNAtotal, climateNA6, by = c("lat", "lon", "ID")) 


```

```{r}
climateNA 
```



# Combine to Datasets: 
```{r}


allData = full_join(static,climateNAtotal, by = c("ID", "lat", "lon")) 
```

# Write to csv

```{r}
write_csv(allData, "../Counterfactual/Output/2006_ChloyaLakes/ChloyaLakes_CombustionModel.csv")
```
**THE END**